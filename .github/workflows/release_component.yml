name: component release

on:
  merge_group:
  workflow_dispatch:

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}-${{ 
    (github.event_name == 'merge_group' && github.event.merge_group.head_sha) || 
    (github.event_name == 'workflow_dispatch' && github.run_id) || 
    github.sha }}
  cancel-in-progress: true
  
env:
  CHIP_NO_LOG_TIMESTAMPS: true
  UPLOAD_FOLDER: tmp
  BIN_FOLDER: bin_files
  LIB_FOLDER: lib_files
  LIB_PATH: tmp/lib_files
  CPC_LIB_PATH: cpc
  LIBC_LIB_PATH: libc
  ZB_LIB_PATH: network/zigbee/zboss
  ZB_PORT_LIB_PATH: network/zigbee/zboss_port
  BLE_LIB_PATH: network/bluetooth/ble-host
  BLE_MESH_LIB_PATH: network/bluetooth/ble-mesh
  L15P4_LIB_PATH: network/lmac15p4
  RT569_LIB_PATH: network/rt569-rf/rt582
  RF_LAB_TEST_PATH: Rafael-SDK-QA/examples/rf-labtest-tool
  CONFIG_FILE: ./.github/config/lib.json
  REPO_ORG: RafaelMicro
  REPO_NAME_DEV : Rafael-IoT-SDK-Internal
  REPO_NAME_QA : Rafael-SDK-QA
  REPO_NAME_COMP : components_dev
  SAFE_FOLDER_NAME: /__w/Rafael-IoT-SDK-Internal/Rafael-IoT-SDK-Internal

jobs:  
  check-branch-name:
    runs-on: ubuntu-latest
    steps:
      - name: æª¢æŸ¥åˆ†æ”¯è³‡è¨Š
        run: |
          if [[ "$GITHUB_REF" != refs/heads/release/v* ]]; then
            echo "åˆ†æ”¯åç¨±ä¸ç¬¦åˆè¦å‰‡ï¼ˆéœ€è¦ä»¥ release/v é–‹é ­ï¼‰"
            exit 1
          else
            echo "åˆ†æ”¯åç¨±ç¬¦åˆè¦å‰‡ï¼š$GITHUB_REF"
          fi
        continue-on-error: false

  trigger-on-RT58x-branch:
    needs: check-branch-name
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/heads/release/')
    steps:
      - name: è¼¸å‡ºåˆ†æ”¯åç¨±
        run: |
          echo "branch name: ${{ github.ref_name }}"
        
  Update-component:  
    name: component update
    needs: check-branch-name  # ä¾è³´ check-branch-nameï¼Œå¤±æ•—ä¸æœƒé‹è¡Œ
    runs-on: ubuntu-latest
    if: github.actor != 'restyled-io[bot]'
    container:
      image: resghst/rafael_sdk_image_test:latest

    steps:
      - name: ğŸ“‚ åˆ‡æ›åˆ° Repository
        uses: actions/checkout@v4
        
      - name: ğŸ”§ å®‰è£ rsync èˆ‡ zip å·¥å…·
        run: |
          apt-get update
          apt-get install -y zip rsync file
          
      - name: ğŸ—‚ï¸ å»ºç«‹èˆ‡è¨­å®š Repository è³‡æ–™å¤¾
        run: |
          mkdir -p $UPLOAD_FOLDER/$BIN_FOLDER
          mkdir -p $UPLOAD_FOLDER/$LIB_FOLDER
          git config --global --add safe.directory ${SAFE_FOLDER_NAME}
          echo "SAFE_DIRECTORY=$(git config --global --get safe.directory)" >> $GITHUB_ENV

      - name: ğŸ§¾ å–å¾— Git ç‰ˆæœ¬è³‡è¨Š
        run: echo "GIT_VERSION=$(git describe --dirty=-QA --always --tags --long --match 'release/*')" >> $GITHUB_ENV

      - name: CMake å·¥å…·éˆäº¤æ›ï¼ˆin âœ æ­£å¼ï¼‰
        run: |
          echo "ğŸ” å°‡ cmake/toolchain.cmake.in æ”¹åç‚º toolchain.cmake"
          if [ -f cmake/toolchain.cmake ]; then
            mv cmake/toolchain.cmake cmake/toolchain.cmake.bak
          fi
          mv cmake/toolchain.cmake.in cmake/toolchain.cmake

      - name: ç·¨è­¯å°ˆæ¡ˆèˆ‡ä¸Šå‚³Library
        uses: ./.github/actions/build_manger
        with:
          json_file: ${{ env.CONFIG_FILE }}
          script_name: docker_build.sh
          upload_folder: ${{ env.UPLOAD_FOLDER }}
          bin_folder: ${{ env.BIN_FOLDER }}
          lib_folder: ${{ env.LIB_FOLDER }}
          git_version: ${{ env.GIT_VERSION }}
          repo_org : ${{ env.REPO_ORG }}
          safe_folder_name : ${{ env.SAFE_FOLDER_NAME }}

      - name: ç”¢ç”Ÿæ—¥æœŸ
        id: date
        run: echo "TODAY=$(date +'%Y/%m/%d')" >> "$GITHUB_ENV"

      - name: ä½¿ç”¨æ—¥æœŸèˆ‡å…¶ä»–ç’°å¢ƒè®Šé‡
        env:
          CREATE_DATE: ${{ steps.date.outputs.today }}
        run: |
          echo "Bin Folder: $BIN_FOLDER"
          echo "Lib Folder: $LIB_FOLDER"
          echo "Config: $CONFIG_FILE"
          echo "Branch: $BRANCH_NAME"
          echo "Repo Org: $REPO_ORG"
          echo "Create Date: $TODAY"
          echo "safe_folder_name: $SAFE_FOLDER_NAME"
          
      - name: ğŸ§ª åˆ†æä¸¦è§£æåˆ†æ”¯ç‰ˆæœ¬è³‡è¨Š
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          # å–å‰ç¶´ï¼ˆä¾‹å¦‚ releaseï¼‰
          PREFIX="${BRANCH_NAME%%/*}"
          # å–å¾—å°¾ç«¯åç¨±ï¼ˆv2.0.0_beta_20250612ï¼‰
          FULL_VERSION="${BRANCH_NAME##*/}"
          # å–ç‰ˆæœ¬è™Ÿï¼ˆä¾‹å¦‚ v2.0.0ï¼‰
          # å¾å°¾ç«¯åç¨±ä¸­åˆ†é›¢ç‰ˆæœ¬è™Ÿï¼ˆv2.0.0ï¼‰
          VERSION="${FULL_VERSION%%_*}"
          # å¾å°¾ç«¯åç¨±ä¸­åˆ†é›¢å¾Œç¶´ï¼ˆbeta_20250612ï¼‰
          SUFFIX="${FULL_VERSION#*_}"
          echo "PREFIX=$PREFIX" >> $GITHUB_ENV
          echo "TAG_NAME=$FULL_VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "SUFFIX=$SUFFIX" >> $GITHUB_ENV
          echo "BRNAME=$BRANCH_NAME" >> $GITHUB_ENV
          echo "SHORT_HASH=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo "Bin Folder: $BIN_FOLDER"
          echo "Lib Folder: $LIB_FOLDER"
          echo "Config: $CONFIG_FILE"
          echo "Branch: $BRANCH_NAME"
          echo "Repo Org: $REPO_ORG"
          echo "Create Date: $CREATE_DATE"
          echo "safe_folder_name: $SAFE_FOLDER_NAME" 
          echo "branch_name: $BRANCH_NAME" 
          echo "version: $VERSION" 
          echo "tag_name: $TAG_NAME"


      - name: âš™ï¸ è¨­å®š Git ä½¿ç”¨è€…è³‡è¨Š
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          # ls -la
          echo ${{ github.workspace }}
          
      - name: è¤‡è£½ Component repository èˆ‡è¨­å®š repository as safe
        run: |
          echo "ğŸ” å˜—è©¦ clone ${REPO_NAME_COMP} repo..."
          git clone https://${{ secrets.RAFAEL_PRIV_TOKEN }}@github.com/${REPO_ORG}/${REPO_NAME_COMP}.git ${REPO_NAME_COMP}
          # æª¢æŸ¥ clone æ˜¯å¦æˆåŠŸ
          if [ ! -d "${REPO_NAME_COMP}" ]; then
            echo "âŒ éŒ¯èª¤ï¼šclone å¾Œè³‡æ–™å¤¾ä¸å­˜åœ¨ï¼Œå¯èƒ½æ˜¯æ¬Šé™å•é¡Œæˆ– repo ä¸å­˜åœ¨"
            exit 1
          fi

          echo "âœ… clone æˆåŠŸï¼Œé¡¯ç¤ºå…§å®¹ï¼š"
          ls -la ${REPO_NAME_COMP}

          echo "ğŸ”’ è¨­å®š safe.directory"
          git config --global --add safe.directory ${SAFE_FOLDER_NAME}/${REPO_NAME_COMP}            

      - name: ğŸ”„ åŒæ­¥ Component èˆ‡é™¤éŒ¯
        run: |
          echo "ğŸ§¹ æ¸…é™¤ component-release ä¸­é™¤äº† .git çš„æ‰€æœ‰å…§å®¹..."
          find ${REPO_NAME_COMP} -mindepth 1 -maxdepth 1 ! -name ".git" -exec rm -rf {} +

          echo "ğŸ”„ åŒæ­¥å‰ component-release è³‡æ–™å¤¾å…§å®¹ï¼š"
          ls -la ./${REPO_NAME_COMP}/
      
          rsync -av --ignore-missing-args \
                --exclude=".git" \
                --exclude="${REPO_NAME_COMP}" \
                --exclude-from=./docs/SDK_Release/Release_sqc_component_ignore_files.txt \
                --delete ./components/ ${REPO_NAME_COMP}/
      
          echo "ğŸ”„ åŒæ­¥å¾Œ component-release è³‡æ–™å¤¾å…§å®¹ï¼š"
          # Step 1: è¼¸å‡º component-release æª”æ¡ˆåˆ—è¡¨
          ls -la ./${REPO_NAME_COMP}/
          # Step 1: è¼¸å‡º ./tmp/lib_files/ æª”æ¡ˆåˆ—è¡¨
          ls -la ./tmp/lib_files/
          
      - name: ğŸ—œï¸å£“ç¸® Library å’Œ è¤‡è£½ library
        shell: bash
        run: |
          echo "tmp/lib_files è³‡æ–™å¤¾å…§å®¹ï¼š"
          pwd
          ls -la ${LIB_PATH}/
          # Step : è¼¸å‡º .component-release/tmp/lib_files/ æª”æ¡ˆåˆ—è¡¨
          #cp ${LIB_PATH}/libcpc.a ${REPO_NAME_COMP}/${CPC_LIB_PATH}/libcpc.a
          #cp ${LIB_PATH}/liblibc.a ${REPO_NAME_COMP}/${LIBC_LIB_PATH}/liblibc.a
          cp ${LIB_PATH}/liblmac15p4.a ${REPO_NAME_COMP}/${L15P4_LIB_PATH}/liblmac15p4.a
          cp ${LIB_PATH}/libzboss_aps_ffd.a ${REPO_NAME_COMP}/${ZB_LIB_PATH}/libzboss_aps_ffd.a
          cp ${LIB_PATH}/libzboss_aps_rfd.a ${REPO_NAME_COMP}/${ZB_LIB_PATH}/libzboss_aps_rfd.a
          cp ${LIB_PATH}/libzboss_mac_ffd.a ${REPO_NAME_COMP}/${ZB_LIB_PATH}/libzboss_mac_ffd.a
          cp ${LIB_PATH}/libzboss_mac_rfd.a ${REPO_NAME_COMP}/${ZB_LIB_PATH}/libzboss_mac_rfd.a
          cp ${LIB_PATH}/libzboss_nwk_ffd.a ${REPO_NAME_COMP}/${ZB_LIB_PATH}/libzboss_nwk_ffd.a
          cp ${LIB_PATH}/libzboss_nwk_rfd.a ${REPO_NAME_COMP}/${ZB_LIB_PATH}/libzboss_nwk_rfd.a
          cp ${LIB_PATH}/libzboss_zcl_ffd.a ${REPO_NAME_COMP}/${ZB_LIB_PATH}/libzboss_zcl_ffd.a
          cp ${LIB_PATH}/libzboss_zcl_rfd.a ${REPO_NAME_COMP}/${ZB_LIB_PATH}/libzboss_zcl_rfd.a
          cp ${LIB_PATH}/libzboss_zdo_ffd.a ${REPO_NAME_COMP}/${ZB_LIB_PATH}/libzboss_zdo_ffd.a
          cp ${LIB_PATH}/libzboss_zdo_rfd.a ${REPO_NAME_COMP}/${ZB_LIB_PATH}/libzboss_zdo_rfd.a
          cp ${LIB_PATH}/libzboss_zgp_ffd.a ${REPO_NAME_COMP}/${ZB_LIB_PATH}/libzboss_zgp_ffd.a
          cp ${LIB_PATH}/libzboss_zgp_rfd.a ${REPO_NAME_COMP}/${ZB_LIB_PATH}/libzboss_zgp_rfd.a
          cp ${LIB_PATH}/libzboss_zse_ffd.a ${REPO_NAME_COMP}/${ZB_LIB_PATH}/libzboss_zse_ffd.a
          cp ${LIB_PATH}/libzboss_zse_rfd.a ${REPO_NAME_COMP}/${ZB_LIB_PATH}/libzboss_zse_rfd.a
          cp ${LIB_PATH}/libzboss_port_ffd.a ${REPO_NAME_COMP}/${ZB_PORT_LIB_PATH}/libzboss_port_ffd.a
          cp ${LIB_PATH}/libzboss_port_rfd.a ${REPO_NAME_COMP}/${ZB_PORT_LIB_PATH}/libzboss_port_rfd.a
          cp ${LIB_PATH}/libzboss_secure_ffd.a ${REPO_NAME_COMP}/${ZB_LIB_PATH}/libzboss_secure_ffd.a
          cp ${LIB_PATH}/libzboss_secure_rfd.a ${REPO_NAME_COMP}/${ZB_LIB_PATH}/libzboss_secure_rfd.a
          cp ${LIB_PATH}/libzboss_common_ffd.a ${REPO_NAME_COMP}/${ZB_LIB_PATH}/libzboss_common_ffd.a
          cp ${LIB_PATH}/libzboss_common_rfd.a ${REPO_NAME_COMP}/${ZB_LIB_PATH}/libzboss_common_rfd.a
          cp ${LIB_PATH}/libzboss_commissioning_ffd.a ${REPO_NAME_COMP}/${ZB_LIB_PATH}/libzboss_commissioning_ffd.a
          cp ${LIB_PATH}/libzboss_commissioning_rfd.a ${REPO_NAME_COMP}/${ZB_LIB_PATH}/libzboss_commissioning_rfd.a
          cp ${LIB_PATH}/libble_host.a ${REPO_NAME_COMP}/${BLE_LIB_PATH}/libble_host.a
          cp ${LIB_PATH}/libble_mesh_server.a ${REPO_NAME_COMP}/${BLE_MESH_LIB_PATH}/libble_mesh_server.a
          cp ${LIB_PATH}/libble_mesh_client.a ${REPO_NAME_COMP}/${BLE_MESH_LIB_PATH}/libble_mesh_client.a

             
      - name: è™•ç†.in æª”æ¡ˆ
        shell: bash
        env:
          CREATE_DATE: ${{ steps.date.outputs.today }}
        run: |
            pwd
            ls -la
            pwd
            echo " ls -la ./${REPO_NAME_COMP}"
            ls -la ./${REPO_NAME_COMP}

            TARGET_DIRS=(
              "${REPO_NAME_COMP}/cpc"
              "${REPO_NAME_COMP}/libc"
              "${REPO_NAME_COMP}/network/bluetooth/ble-host"
              "${REPO_NAME_COMP}/network/bluetooth/ble-mesh"
              "${REPO_NAME_COMP}/network/bluetooth/hci_bridge"
              "${REPO_NAME_COMP}/network/lmac15p4"
              "${REPO_NAME_COMP}/network/ruci"
              "${REPO_NAME_COMP}/network/zigbee/zboss"
              "${REPO_NAME_COMP}/network/zigbee/zboss_port"
            )
            
            for dir in "${TARGET_DIRS[@]}"; do
              in_file="$dir/CMakeLists.txt.in"
              txt_file="$dir/CMakeLists.txt"
            
              if [ -f "$in_file" ]; then
                echo "è™•ç†: $in_file"
            
                [ -f "$txt_file" ] && echo " åˆªé™¤å·²å­˜åœ¨çš„ $txt_file" && rm "$txt_file"
            
                echo "é‡å‘½å $in_file â†’ $txt_file"
                mv "$in_file" "$txt_file"
              else
                echo "â­è·³éï¼š$in_file ä¸å­˜åœ¨"
              fi
            done
            ls -la ./components/network/bluetooth/ble-host

            # åˆªé™¤ ulity ç‰¹å®šç›®éŒ„ä¸­çš„ *.in æª”æ¡ˆ
            TARGET_UTILITY_DIRS=(
              "${REPO_NAME_COMP}/utility/LzmaDec"
              "${REPO_NAME_COMP}/utility/Version_Information"
              "${REPO_NAME_COMP}/utility/cli"
              "${REPO_NAME_COMP}/utility/log"
            )
            
            for dir in "${TARGET_UTILITY_DIRS[@]}"; do
              echo " è™•ç†: $dir ä¸­çš„ *.in æª”æ¡ˆ"
            
              find "$dir" -type f -name "*.in" | while read -r file; do
                echo "åˆªé™¤: $file"
                rm -f "$file"
              done
            done         

      - name: é‚„åŸ CMake å·¥å…·éˆï¼ˆtoolchain âœ inï¼‰
        run: |
          ls -la cmake/
          echo "ğŸ” å°‡ cmake/toolchain.cmake é‚„åŸæˆ toolchain.cmake.in"
          if [ -f cmake/toolchain.cmake ]; then
            mv cmake/toolchain.cmake cmake/toolchain.cmake.in
          fi
          if [ -f cmake/toolchain.cmake.bak ]; then
            mv cmake/toolchain.cmake.bak cmake/toolchain.cmake
          fi
          ls -la cmake/
          
      - name: ç§»é™¤é™¤äº† components è³‡æ–™å¤¾ä»¥å¤–çš„å…§å®¹ä¸¦æ¨é€
        shell: bash
        run: |
          pwd
          echo "æª¢æŸ¥ç›®å‰æœ‰å“ªäº›è³‡æ–™å¤¾ï¼š"
          ls -la
          echo "åˆ‡æ›åˆ° components_dev è³‡æ–™å¤¾"
          cd "${REPO_NAME_COMP}"
          pwd
          echo "ğŸ” ls -la"
          ls -la
          
          echo "ğŸ” Git remote è¨­å®šï¼š"
          git remote -v

          rm -rf ./tmp
          rm -rf ./make_scripts
          rm -rf ./bluetooth-le
          rm -rf ./zigbee

          echo "âœ… å‰©é¤˜å…§å®¹å¦‚ä¸‹ï¼ˆæ‡‰è©²åªæœ‰ components/ï¼‰ï¼š"
          ls -la
          pwd

      - name: Show git log (main repo)
        run: |
          pwd
          ls -la
          git --no-pager log --oneline --graph --decorate -n 5

      - name: Show git log (components_kc)
        run: |
          pwd
          ls -la
          cd "${REPO_NAME_COMP}"
          pwd
          ls -la
          git --no-pager log --oneline --graph --decorate -n 5

          echo "ğŸ“¦ Git commit ä¸¦æ¨é€åˆ° components_dev"
          git add -A
          git commit -m "${TODAY} ${PREFIX} ${VERSION}" || echo "âš ï¸ ç„¡æª”æ¡ˆè®Šæ›´ï¼Œè·³é commit"

          echo "ğŸ” ç›®å‰æ‰€åœ¨è·¯å¾‘ï¼š$(pwd)"
          echo "ğŸ” Git branchï¼š$(git branch)"
          echo "ğŸ” Git remote è¨­å®šï¼š"
          git remote -v

          echo "ğŸ” Git ç‹€æ…‹ï¼š"
          git status

          # å˜—è©¦æ¨é€ main åˆ†æ”¯
          echo "ğŸ“¦ æ¨é€ main"
          git branch -M main
          git push origin main || { echo "âŒ push main å¤±æ•—"; exit 1; }

          # æ¨é€åˆ†æ”¯
          echo "ğŸ“¦ å»ºç«‹ä¸¦æ¨é€åˆ†æ”¯ ${BRNAME}"
          git push origin main

      - name: ğŸ“ å»ºç«‹ Release Noteï¼ˆcomponents repoï¼‰
        env:
          GH_TOKEN: ${{ secrets.RAFAEL_PRIV_TOKEN }}  # ä½¿ç”¨ GitHub æä¾›çš„ token ä¾†åŸ·è¡Œå‹•ä½œ
        run: |
          pwd
          cd ${REPO_NAME_COMP}
          pwd
          cat <<EOF > component.md
          ![Date](https://img.shields.io/badge/Date-${TODAY}-green) 
          ![Release](https://img.shields.io/badge/Release-${TAG_NAME}-blue) 
          ![commit](https://img.shields.io/badge/Track_commit_hash-${SHORT_HASH}-yellow)
          EOF

      - name: ğŸš€ ç™¼å¸ƒ Release åˆ° GitHub
        env:
          GH_TOKEN: ${{ secrets.RAFAEL_PRIV_TOKEN }}  # ä½¿ç”¨ GitHub æä¾›çš„ token ä¾†åŸ·è¡Œå‹•ä½œ
        run: |
            pwd
            cd ${REPO_NAME_COMP}
            pwd
            git remote set-url origin https://${{ secrets.RAFAEL_PRIV_TOKEN }}@github.com/${REPO_ORG}/${REPO_NAME_COMP}.git
            gh release create "$TAG_NAME" \
              --repo "${REPO_ORG}/${REPO_NAME_COMP}" \
              --title "$TAG_NAME" \
              --notes-file "./component.md"


